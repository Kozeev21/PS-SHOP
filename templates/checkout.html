{% extends "base.html" %}
{% block content %}
<div style="max-width: 800px; margin: 30px auto; padding: 0 20px;">
    <h1 style="text-align: center; margin-bottom: 30px; color: #333;">‚úÖ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    
    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <!-- 1. –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333; margin-bottom: 15px; font-size: 22px;">
                1. –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ 
                <button type="button" onclick="toggleEditForm()" 
                        style="margin-left: 15px; padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
            </h2>
            
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö -->
            <div id="address-display" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                    <div style="font-size: 24px; margin-right: 15px;">üìç</div>
                    <div>
                        <p style="margin: 0 0 5px 0; font-weight: 600;">–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö</p>
                        <p id="current-address" style="margin: 0; color: #333;">
                            {{ session.get('user_cdek_address', '–ù–µ —É–∫–∞–∑–∞–Ω') }}
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start;">
                    <div style="font-size: 24px; margin-right: 15px;">üë§</div>
                    <div>
                        <p style="margin: 0 0 5px 0; font-weight: 600;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</p>
                        <p id="current-name" style="margin: 0; color: #333;">
                            {{ session.get('user_name', '') }} {{ session.get('user_surname', '') }}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="address-edit-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                <form id="edit-delivery-form" onsubmit="return saveDeliveryData(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–ò–º—è:</label>
                        <input type="text" id="edit-name" name="name" 
                            value="{{ session.get('user_name', '') }}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                            required>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="edit-surname" name="surname" 
                            value="{{ session.get('user_surname', '') }}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                            required>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö *
                        </label>
                        <input type="text" id="edit-address" name="cdek_address" 
                            value="{{ session.get('user_cdek_address', '') }}"
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1, –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö ‚Ññ123"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                            required>
                        <small style="display: block; margin-top: 5px; color: #666;">
                            –£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏ –°–î–≠–ö
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" 
                                style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button type="button" onclick="toggleEditForm()"
                                style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 2. –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ -->
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333; margin-bottom: 15px; font-size: 22px;">2. –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h2>
            <div id="order-summary" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã -->
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
                </div>
            </div>
        </div>
        
        <!-- 3. –û–ø–ª–∞—Ç–∞ -->
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333; margin-bottom: 15px; font-size: 22px;">3. –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="width: 40px; height: 40px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border: 1px solid #ddd;">
                        <span style="font-size: 20px;">üí≥</span>
                    </div>
                    <div>
                        <p style="margin: 0 0 5px 0; font-weight: 600;">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</p>
                        <p style="margin: 0; color: #666; font-size: 14px;">Visa, Mastercard, –ú–ò–† —á–µ—Ä–µ–∑ –ÆKassa</p>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <p style="margin: 0; font-size: 14px; color: #666;">
                        üîí –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É PCI DSS. 
                        –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω.
                    </p>
                </div>
                
                <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                <div id="order-total" style="background: #fff; padding: 20px; border-radius: 6px; margin-top: 20px; border: 1px solid #e0e0e0; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="margin: 0 0 5px 0; font-weight: 600;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</p>
                            <p style="margin: 0; color: #666; font-size: 14px;" id="items-count">0 —Ç–æ–≤–∞—Ä–æ–≤</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="total-price">0 ‚ÇΩ</div>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">–í–∫–ª—é—á–∞—è –¥–æ—Å—Ç–∞–≤–∫—É</p>
                        </div>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="window.location.href='/cart'" 
                            style="flex: 1; min-width: 200px; padding: 15px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s;"
                            onmouseover="this.style.transform='translateY(-2px)';"
                            onmouseout="this.style.transform='translateY(0)';">
                        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                    
                    <button id="pay-button" 
                            style="flex: 2; min-width: 250px; padding: 17px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s;"
                            onmouseover="this.style.transform='translateY(-2px)';"
                            onmouseout="this.style.transform='translateY(0)';"
                            onclick="processRealPayment()">
                        <span style="font-size: 20px;">üí≥</span>
                        <span id="pay-button-text">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</span>
                    </button>
                </div>
            </div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loading" style="display: none; text-align: center; padding: 20px; margin-top: 15px;">
                <div style="display: inline-block; padding: 15px 30px; background: rgba(0,123,255,0.1); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div>
                            <p style="margin: 0; font-weight: 600; color: #007bff;">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã...</p>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
                <div style="color: #856404; font-size: 18px;">‚ÑπÔ∏è</div>
                <div>
                    <p style="margin: 0 0 5px 0; color: #856404; font-weight: 600;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç—å" –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ÆKassa –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartButton() {
    let total = 0;
    for (let key in localStorage) {
        if (key.startsWith('product_quantity_')) {
            total += parseInt(localStorage.getItem(key)) || 0;
        }
    }
    
    const cartButtons = document.querySelectorAll('[id^="cart-button"], .cart-button');
    cartButtons.forEach(button => {
        if (button) {
            button.textContent = total === 0 ? 'üõí –ö–æ—Ä–∑–∏–Ω–∞' : `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${total})`;
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–∞–≤–∞ –∑–∞–∫–∞–∑–∞
function loadOrderSummary() {
    const cartItems = [];
    let totalPrice = 0;
    let totalItems = 0;
    
    // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        if (key.startsWith('product_quantity_')) {
            const productId = key.replace('product_quantity_', '');
            const quantity = parseInt(localStorage.getItem(key)) || 0;
            
            if (quantity > 0) {
                const productName = localStorage.getItem(`product_${productId}`) || `–¢–æ–≤–∞—Ä ${productId}`;
                const productPrice = parseFloat(localStorage.getItem(`product_price_${productId}`)) || 0;
                const productImg = localStorage.getItem(`product_img_${productId}`) || '';
                const itemTotal = productPrice * quantity;
                
                totalPrice += itemTotal;
                totalItems += quantity;
                
                cartItems.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity,
                    image: productImg,
                    total: itemTotal
                });
            }
        }
    }
    
    const orderSummary = document.getElementById('order-summary');
    const orderTotal = document.getElementById('order-total');
    const payButton = document.getElementById('pay-button');
    
    if (cartItems.length === 0) {
        orderSummary.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <p style="color: #666; margin-bottom: 15px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                <button onclick="window.location.href='/shop'" 
                        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
                </button>
            </div>
        `;
        orderTotal.style.display = 'none';
        payButton.disabled = true;
        payButton.style.opacity = '0.6';
        payButton.style.cursor = 'not-allowed';
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    orderTotal.style.display = 'block';
    document.getElementById('total-price').textContent = totalPrice.toFixed(0) + ' ‚ÇΩ';
    document.getElementById('items-count').textContent = totalItems + ' —Ç–æ–≤–∞—Ä' + (totalItems !== 1 ? '–∞' : '');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    document.getElementById('pay-button-text').textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ${totalPrice.toFixed(0)} ‚ÇΩ`;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    let html = `
        <div style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
            <div style="display: grid; gap: 15px;">
    `;
    
    cartItems.forEach(item => {
        html += `
            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee;">
                <img src="${item.image || 'https://via.placeholder.com/60x60/cccccc/666666?text=No+Image'}" 
                     alt="${item.name}"
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                
                <div style="flex: 1;">
                    <p style="margin: 0 0 5px 0; font-weight: 600; font-size: 15px;">${item.name}</p>
                    <p style="margin: 0; color: #666; font-size: 14px;">${item.price} ‚ÇΩ √ó ${item.quantity}</p>
                </div>
                
                <div style="text-align: right;">
                    <p style="margin: 0; font-weight: bold; font-size: 16px;">${item.total} ‚ÇΩ</p>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    orderSummary.innerHTML = html;
}

// –†–ï–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ü–õ–ê–¢–´ –ß–ï–†–ï–ó –ÆKASSA
async function processRealPayment() {
    const payButton = document.getElementById('pay-button');
    const loading = document.getElementById('loading');
    
    // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    const orderItems = [];
    let totalPrice = 0;
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('product_quantity_')) {
            const productId = key.replace('product_quantity_', '');
            const quantity = parseInt(localStorage.getItem(key)) || 0;
            
            if (quantity > 0) {
                const productName = localStorage.getItem(`product_${productId}`) || `–¢–æ–≤–∞—Ä ${productId}`;
                const productPrice = parseFloat(localStorage.getItem(`product_price_${productId}`)) || 0;
                const productImg = localStorage.getItem(`product_img_${productId}`) || '';
                
                totalPrice += productPrice * quantity;
                
                orderItems.push({
                    product_id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity,
                    image: productImg,
                    total: productPrice * quantity
                });
            }
        }
    }
    
    if (orderItems.length === 0 || totalPrice === 0) {
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π.');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É (–ÆKassa —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 1 —Ä—É–±–ª—å)
    if (totalPrice < 1) {
        alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ - 1 —Ä—É–±–ª—å.');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    payButton.disabled = true;
    payButton.style.opacity = '0.7';
    loading.style.display = 'block';
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –†–ï–ê–õ–¨–ù–û–ì–û –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa
        const response = await fetch('/create_real_payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: totalPrice.toFixed(2),
                items: orderItems
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –†–ï–ê–õ–¨–ù–´–ô –†–ï–î–ò–†–ï–ö–¢ –ù–ê –°–¢–†–ê–ù–ò–¶–£ –ÆKASSA
            console.log('–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞:', data.confirmation_url);
            window.location.href = data.confirmation_url;
        } else {
            // –û—à–∏–±–∫–∞
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            payButton.disabled = false;
            payButton.style.opacity = '1';
            loading.style.display = 'none';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        payButton.disabled = false;
        payButton.style.opacity = '1';
        loading.style.display = 'none';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateCartButton();
    loadOrderSummary();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function toggleEditForm() {
    const displayDiv = document.getElementById('address-display');
    const editFormDiv = document.getElementById('address-edit-form');
    
    if (editFormDiv.style.display === 'none' || editFormDiv.style.display === '') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        displayDiv.style.display = 'none';
        editFormDiv.style.display = 'block';
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        displayDiv.style.display = 'block';
        editFormDiv.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏
async function saveDeliveryData(event) {
    event.preventDefault();
    
    const name = document.getElementById('edit-name').value.trim();
    const surname = document.getElementById('edit-surname').value.trim();
    const address = document.getElementById('edit-address').value.trim();
    
    if (!name || !surname || !address) {
        alert('–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return false;
    }
    
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveButton = event.target.querySelector('button[type="submit"]');
        const originalText = saveButton.textContent;
        saveButton.disabled = true;
        saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/api/update_delivery', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                surname: surname,
                cdek_address: address
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('current-name').textContent = `${name} ${surname}`;
            document.getElementById('current-address').textContent = address;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if (data.updated_session) {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
                // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                window.location.reload();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            toggleEditForm();
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const saveButton = event.target.querySelector('button[type="submit"]');
        saveButton.disabled = false;
        saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
if (!document.querySelector('#notification-styles-checkout')) {
    const style = document.createElement('style');
    style.id = 'notification-styles-checkout';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
#order-summary::-webkit-scrollbar {
    width: 6px;
}

#order-summary::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#order-summary::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

#order-summary::-webkit-scrollbar-thumb:hover {
    background: #555;
}

@media (max-width: 768px) {
    div[style*="display: flex"] {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        min-width: unset !important;
    }
}

</style>
{% endblock %}