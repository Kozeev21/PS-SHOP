{% extends "base.html" %}
{% block content %}
<div style="max-width: 800px; margin: 30px auto; padding: 0 20px;">
    <h1 style="text-align: center; margin-bottom: 30px;">‚úÖ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    
    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333;">1. –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
                <p><strong>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö:</strong> {{ session.get('user_cdek_address', '–ù–µ —É–∫–∞–∑–∞–Ω') }}</p>
                <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {{ session.get('user_name', '') }} {{ session.get('user_surname', '') }}</p>
                <button onclick="window.location.href='/profile'" 
                        style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                    –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333;">2. –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞</h2>
            <div id="order-summary" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–æ–≤–∞—Ä—ã -->
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333;">3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <form id="checkout-form" method="POST" action="/checkout">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <p>–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –æ–ø–ª–∞—Ç—ã.</p>
                    
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" onclick="window.location.href='/cart'" 
                                style="flex: 1; padding: 15px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                        
                        <button type="submit" 
                                style="flex: 2; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartButton() {
    let total = 0;
    for (let key in localStorage) {
        if (key.startsWith('product_quantity_')) {
            total += parseInt(localStorage.getItem(key)) || 0;
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const cartButtons = document.querySelectorAll('[id^="cart-button"], .cart-button');
    cartButtons.forEach(button => {
        if (button) {
            button.textContent = total === 0 ? 'üõí –ö–æ—Ä–∑–∏–Ω–∞' : `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${total})`;
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
function clearAllCartData() {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('product_')) {
            keysToRemove.push(key);
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–æ—Ä–∑–∏–Ω—ã
    updateCartButton();
    
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞');
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadOrderSummary();
});

function loadOrderSummary() {
    const cartItems = [];
    let totalPrice = 0;
    let totalItems = 0;
    
    // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        if (key.startsWith('product_quantity_')) {
            const productId = key.replace('product_quantity_', '');
            const quantity = parseInt(localStorage.getItem(key)) || 0;
            
            if (quantity > 0) {
                const productName = localStorage.getItem(`product_${productId}`) || `–¢–æ–≤–∞—Ä ${productId}`;
                const productPrice = parseFloat(localStorage.getItem(`product_price_${productId}`)) || 0;
                const itemTotal = productPrice * quantity;
                
                totalPrice += itemTotal;
                totalItems += quantity;
                
                cartItems.push({
                    name: productName,
                    price: productPrice,
                    quantity: quantity,
                    total: itemTotal
                });
            }
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ç–æ–≥–∏
    const orderSummary = document.getElementById('order-summary');
    
    if (cartItems.length === 0) {
        orderSummary.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    cartItems.forEach(item => {
        html += `
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
            <div>
                ${item.name} √ó ${item.quantity}
            </div>
            <div style="font-weight: bold;">
                ${item.total} ‚ÇΩ
            </div>
        </div>
        `;
    });
    
    html += `
        <div style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; border-top: 2px solid #007bff;">
            <div>–ò—Ç–æ–≥–æ:</div>
            <div style="color: #007bff;">${totalPrice.toFixed(0)} ‚ÇΩ</div>
        </div>
    `;
    
    orderSummary.innerHTML = html;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
    let hasItems = false;
    for (let key in localStorage) {
        if (key.startsWith('product_quantity_')) {
            const quantity = parseInt(localStorage.getItem(key)) || 0;
            if (quantity > 0) {
                hasItems = true;
                break;
            }
        }
    }
    
    if (!hasItems) {
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.');
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    clearAllCartData();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
    this.submit();
});
</script>
{% endblock %}